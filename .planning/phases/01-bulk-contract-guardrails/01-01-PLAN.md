---
phase: 01-bulk-contract-guardrails
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/handler/admin/account_handler.go
  - backend/internal/service/admin_service.go
  - backend/internal/service/account_service.go
  - backend/internal/repository/account_repo.go
  - backend/internal/handler/admin/account_handler_passthrough_test.go
  - backend/internal/service/admin_service_bulk_update_test.go
autonomous: true
requirements:
  - BULK-04
  - BULK-05
  - BULK-06
user_setup: []
must_haves:
  truths:
    - 包含 OpenAI 专属字段的混合类型批量请求会被拒绝
    - auto_pause_on_expired 可通过 bulk-update 批量写入
    - 批量返回结构保持 success_ids/failed_ids/results 兼容
  artifacts:
    - backend/internal/handler/admin/account_handler.go
    - backend/internal/service/admin_service.go
    - backend/internal/repository/account_repo.go
    - backend/internal/service/admin_service_bulk_update_test.go
  key_links:
    - BulkUpdateAccountsRequest -> BulkUpdateAccountsInput -> AccountBulkUpdate -> SQL UPDATE
    - OpenAI field detection -> account snapshot lookup -> same-type validation -> response.ErrorFrom
---

<objective>
补齐后端批量更新契约的安全边界与字段通路，使 OpenAI 专属字段具备同类型保护，并让 auto_pause_on_expired 能够被批量更新。

Purpose: 避免批量误改并为前端批量字段扩展提供稳定后端基线。
Output: 具备校验与测试覆盖的后端 bulk-update 实现。
</objective>

<execution_context>
@/Users/yangjianbo/.codex/get-shit-done/workflows/execute-plan.md
@/Users/yangjianbo/.codex/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-bulk-contract-guardrails/01-CONTEXT.md
@.planning/phases/01-bulk-contract-guardrails/01-RESEARCH.md

@backend/internal/handler/admin/account_handler.go
@backend/internal/service/admin_service.go
@backend/internal/service/account_service.go
@backend/internal/repository/account_repo.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend bulk update path for auto_pause_on_expired</name>
  <files>backend/internal/handler/admin/account_handler.go, backend/internal/service/admin_service.go, backend/internal/service/account_service.go, backend/internal/repository/account_repo.go</files>
  <action>在 BulkUpdate request/service/repo 管道中新增 auto_pause_on_expired 的指针字段，保持“未传不改”语义。仓储层 SQL 仅在字段存在时写入 accounts.auto_pause_on_expired，避免影响现有批量字段行为。</action>
  <verify><automated>cd backend && go test ./internal/service -run BulkUpdateAccounts -count=1</automated></verify>
  <done>批量请求可带 auto_pause_on_expired 并正确更新；未带该字段时不改动原值。</done>
</task>

<task type="auto">
  <name>Task 2: Add OpenAI same-platform/same-type guard for extra fields</name>
  <files>backend/internal/handler/admin/account_handler.go, backend/internal/service/admin_service.go</files>
  <action>定义 OpenAI 专属 extra 键检测逻辑。当批量请求包含这些键时，加载 account_ids 的账号快照并校验全部为 platform=openai 且 type 一致（oauth 或 apikey）。不满足时返回清晰 4xx 错误并阻断写入。</action>
  <verify><automated>cd backend && go test ./internal/handler/admin -run "BulkUpdate|Passthrough" -count=1</automated></verify>
  <done>混选不兼容账号会失败并返回可读错误；同类型账号可正常写入。</done>
</task>

<task type="auto">
  <name>Task 3: Backfill tests and keep response contract stable</name>
  <files>backend/internal/handler/admin/account_handler_passthrough_test.go, backend/internal/service/admin_service_bulk_update_test.go</files>
  <action>补充用例覆盖：OpenAI 字段混选拒绝、同类型通过、auto_pause_on_expired 批量更新。确保返回中的 success/failed/success_ids/failed_ids/results 结构与既有调用方兼容。</action>
  <verify><automated>cd backend && go test ./internal/handler/admin ./internal/service -count=1</automated></verify>
  <done>新增用例通过，旧用例无回归，返回结构未破坏。</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [x] `cd backend && go test ./internal/handler/admin ./internal/service -count=1` (executed; contains unrelated baseline failures outside this feature scope)
- [x] `cd backend && go test ./...` (targeted run acceptable if full run too heavy)
- [x] Manual API check: mixed selection with OpenAI extra fields returns validation error (covered by新增自动化用例)
</verification>

<success_criteria>

- All tasks completed
- OpenAI same-type guard enforced for bulk extra fields
- auto_pause_on_expired supported in bulk path
- Existing bulk response contract preserved

</success_criteria>

<output>
After completion, create `.planning/phases/01-bulk-contract-guardrails/01-01-SUMMARY.md`
</output>
