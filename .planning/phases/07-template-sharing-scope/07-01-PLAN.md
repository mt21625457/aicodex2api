# Plan 07-01: 模板服务端共享（团队/分组范围）

## 目标

落地 BULK-12：批量编辑模板从本地存储升级为服务端存储，并支持共享范围（个人 / 团队 / 分组）与可见性过滤。

## 范围

- 后端：新增 `bulk_edit_template_library_v1` 设置项存储与 CRUD API
- 前端：批量编辑模板区接入服务端 API，新增共享范围与分组选择
- 兼容：保留现有“同平台 + 同类型”模板作用域与批量编辑约束

## 设计决策

1. **存储方式**
   - 使用现有 settings 表（JSON blob），避免新增表和迁移。
   - Key: `bulk_edit_template_library_v1`

2. **共享范围模型**
   - `private`: 仅创建者可见
   - `team`: 全部管理员可见
   - `groups`: 仅在当前批量编辑 scope 的分组交集内可见

3. **可见性过滤输入**
   - 前端在打开批量编辑时根据当前命中账号计算 `scope_group_ids`
   - 后端 GET API 根据 `scope_platform/scope_type/scope_group_ids` 过滤模板

4. **最小侵入实现**
   - 不改 `AdminService` 依赖链
   - 在 `SettingService + admin/SettingHandler + /admin/settings` 路由内实现

## 任务拆解

- [ ] 后端
  - [ ] 新增 setting key 常量
  - [ ] 新增模板库服务模型与读写方法（list/upsert/delete）
  - [ ] 新增 admin settings 模板 API（三个接口）
  - [ ] 路由注册

- [ ] 前端
  - [ ] 新增 settings API 类型与方法
  - [ ] 模板模型支持 `shareScope/groupIds`
  - [ ] 批量编辑模板 UI 增加共享范围与分组
  - [ ] AccountsView 透传 scope 分组上下文到批量编辑弹窗

- [ ] 测试
  - [ ] 后端 service 单测（可见性过滤、upsert、delete）
  - [ ] 后端 handler 单测（参数校验、权限边界、接口链路）
  - [ ] 前端模板映射/存储单测
  - [ ] 前端 settings API 适配单测

## 验收标准

1. 管理员可创建模板并选择共享范围（private/team/groups）。
2. 模板列表按平台+类型过滤，并对 `groups` 模板执行分组交集过滤。
3. 现有“只对同平台同类型账号批量编辑”行为保持不变。
4. 新增/修改代码均有单元测试，相关改动覆盖率 > 85%。

## 风险与缓解

- 风险：settings JSON 并发覆盖
  - 缓解：单次读-改-写、保持幂等 upsert（同 scope + 同名覆盖）
- 风险：前端 group 上下文缺失导致 groups 模板误显示
  - 缓解：GET 接口默认无 `scope_group_ids` 时不返回 groups 模板
