---
phase: 10-openai-wsv2-ctx-pool-normalization-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/internal/service/openai_ws_forwarder.go
  - backend/internal/service/openai_ws_state_store.go
  - backend/internal/service/openai_ws_forwarder_ingress_test.go
  - backend/internal/service/openai_ws_forwarder_ingress_session_test.go
  - backend/internal/service/openai_ws_fallback_test.go
  - backend/internal/service/openai_ws_state_store_test.go
  - .planning/phases/10-openai-wsv2-ctx-pool-normalization-hardening/10-CONTEXT.md
autonomous: true
requirements:
  - WSV2-CTX-NORMALIZER
  - WSV2-CTX-PENDING-CROSS-INSTANCE
  - WSV2-CTX-INVARIANT-FIRST
  - WSV2-CTX-RECOVERY-MATRIX
  - WSV2-CTX-REGRESSION-MATRIX
user_setup: []
must_haves:
  truths:
    - ctx_pool 发送前归一化逻辑收敛到统一入口，避免分支重复修补
    - response->pending_call_ids 支持跨实例读取并保持本地热缓存命中
    - previous_response_id 判定遵循 call/output 成对不变量优先
    - tool_output_not_found / previous_response_not_found 既有恢复矩阵不退化
    - 回归测试覆盖 aborted 注入、orphan 清理与 debug/release 差异路径
  artifacts:
    - backend/internal/service/openai_ws_forwarder.go
    - backend/internal/service/openai_ws_state_store.go
    - backend/internal/service/openai_ws_forwarder_ingress_session_test.go
    - backend/internal/service/openai_ws_state_store_test.go
  key_links:
    - .planning/todos/pending/2026-02-28-refactor-ctx-pool-wsv2-normalization-invariants.md
---

# Phase 10 Plan 01: ctx_pool WSv2 归一化与不变量收敛

## Objective
- **What:** 将 `ctx_pool` WSv2 的发送前处理收敛为统一 normalizer，并补齐跨实例 pending 状态与不变量判定。
- **Why:** 降低散落分支导致的回归风险，消除 ESC 取消 function_call 等场景下续链不稳定问题。
- **Output:** 统一归一化入口 + 跨实例 pending_call_ids 状态 + 不变量优先判定与指标 + 回归测试矩阵。

## Context
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-openai-wsv2-ctx-pool-normalization-hardening/10-CONTEXT.md
@.planning/todos/pending/2026-02-28-refactor-ctx-pool-wsv2-normalization-invariants.md

## Tasks

<task type="code">
  <name>Task 1: 抽取统一 pre-send normalizer</name>
  <files>backend/internal/service/openai_ws_forwarder.go</files>
  <action>将 before-turn 中分散的 previous_response_id infer/align、aborted 注入、orphan 清理逻辑收敛到单一 normalizer 入口，保持现有行为兼容。</action>
  <verify>新增/更新单测验证 normalizer 输入输出与现有关键路径一致。</verify>
  <done>发送上游前只通过统一入口做归一化，删除重复分支修补逻辑。</done>
</task>

<task type="code">
  <name>Task 2: pending_call_ids 跨实例状态化</name>
  <files>backend/internal/service/openai_ws_state_store.go</files>
  <action>为 response->pending_call_ids 增加共享缓存回源能力（本地热缓存 + Redis 回源），TTL 与 response 粘连一致。</action>
  <verify>补充 state store 测试，覆盖本地命中、过期、回源、删除、回填热缓存。</verify>
  <done>跨实例可读取 pending_call_ids，且本地热缓存维持低延迟访问。</done>
</task>

<task type="code">
  <name>Task 3: previous_response_id 判定升级为 invariant-first</name>
  <files>backend/internal/service/openai_ws_forwarder.go, backend/internal/service/openai_ws_forwarder_ingress_test.go</files>
  <action>在 keep/drop 判定中优先使用 call/output 成对不变量；补齐“有 output 但 pending 未知”场景策略，并新增 reason/metric 标签。</action>
  <verify>补充 ingress 单测覆盖 call_id match、mismatch、unknown pending 三类路径。</verify>
  <done>判定原因可观测且可解释，未知态不再走隐式分支。</done>
</task>

<task type="code">
  <name>Task 4: 保护现有 recover matrix</name>
  <files>backend/internal/service/openai_ws_forwarder.go, backend/internal/service/openai_ws_fallback_test.go, backend/internal/service/openai_ws_forwarder_ingress_session_test.go</files>
  <action>确保 tool_output_not_found 仍是单次 drop-prev 重放；previous_response_not_found 仍是先对齐后降级，避免行为回退。</action>
  <verify>复用并扩展现有 ingress session/fallback 测试，确认恢复链路与重试次数不变。</verify>
  <done>恢复矩阵关键断言全部通过，日志 reason 保持兼容。</done>
</task>

<task type="test">
  <name>Task 5: 引入 Codex 风格回归矩阵</name>
  <files>backend/internal/service/openai_ws_forwarder_ingress_session_test.go, backend/internal/service/openai_ws_state_store_test.go</files>
  <action>补齐 aborted 自动注入、orphan 清理、debug/release 差异行为测试映射，形成可持续回归集合。</action>
  <verify>在 debug/release 两种构建模式下关键用例都可给出预期结果。</verify>
  <done>新增测试覆盖本 phase 5 项需求，且通过 `go test`。</done>
</task>

## Verification
- [ ] `cd backend && go test ./internal/service -run 'OpenAIWS|CtxPool|ToolOutputNotFound|StateStore' -count=1`
- [ ] `cd backend && go test ./internal/service -count=1`
- [ ] `cd backend && go test -tags=unit ./...`

## Success Criteria
- [ ] pre-send normalizer 成为唯一归一化入口，行为与既有链路兼容
- [ ] pending_call_ids 支持跨实例读取（含回源与热缓存）
- [ ] previous_response_id 判定实现 invariant-first，unknown pending 场景有明确策略
- [ ] recover matrix 行为不回退
- [ ] 回归测试矩阵覆盖 5 类核心场景并稳定通过
