## Context

本项目前端采用 Vue 3 + Vite。当前性能瓶颈不是单点，而是“构建分包策略 + 后台重页面组织 + 运行时重复开销”叠加导致。目标是在不改变现有业务功能与外部接口的前提下，系统性降低加载与运行时成本。

约束：
- 必须保持现有路由、接口、权限、配置语义不变
- 必须支持灰度、可回滚
- 必须保证新旧前端版本在滚动发布期间可共存

## Goals / Non-Goals

**Goals**
- 降低首屏及核心后台页面 JS 传输与执行成本
- 降低重页面（尤其 `AccountsView`）的首进页面开销
- 移除运行时冗余调用与高频重计算
- 建立前端性能发布门禁与可回滚机制

**Non-Goals**
- 不改动后端 API 契约
- 不重写 UI 框架/设计系统
- 不引入破坏性路由结构变更

## Decisions

### D1: 分包策略改为“功能边界优先”

**选择**：按“关键路径/后台重功能/低频工具”拆包，避免 `vendor-misc` 与 `vendor-ui` 过度混合。

**理由（最优性）**：
- 直接减少非关键代码进入关键链路的概率
- 比仅做 gzip/压缩参数微调收益更高且可控
- 与 Vite 的 `manualChunks` 机制天然兼容，落地成本低

### D2: `xlsx` 从共享 UI 包独立

**选择**：`xlsx` 单独 chunk，仅在导出场景按需加载。

**理由（最优性）**：
- `xlsx` 体积大、使用频率低，天然适合延迟加载
- 与 `@vueuse/core` 解耦后可避免“轻页面背重工具”

### D3: 路由预取从固定邻接表升级为自适应策略

**选择**：保留现有邻接表作为 `legacy`，新增 `adaptive` 模式：
- 低带宽/低内存设备禁用重页面预取
- 重页面仅在空闲预算充足时预取

**理由（最优性）**：
- 兼顾弱网设备体验与高端设备速度
- 比“一刀切关闭预取”更平衡

### D4: onboarding 与公告能力延迟初始化

**选择**：`driver.js` 与公告详情渲染链路（`marked + DOMPurify`）改为惰性加载。

**理由（最优性）**：
- 二者均非每次访问必需，适合按需加载
- 可显著减轻 `AppLayout/AppHeader` 公共链路

### D5: `AccountsView` 全量静态依赖改按需加载

**选择**：重弹窗/重图表/低频面板改 `defineAsyncComponent` + 触发时加载。

**理由（最优性）**：
- 对最大 chunk 直接见效
- 不改变页面功能，仅改变加载时机，兼容风险低

### D6: 模型白名单从“单文件硬编码”改“静态分片 + 远程增量 + 回退”

**选择**：
- 平台级模型清单先做静态分片（首选主路径）
- 远程配置仅做增量覆盖（可选）
- 远程失败时无条件回退静态分片快照

**理由（最优性）**：
- 静态分片可立即降包且不引入强依赖
- 远程增量可减少后续发版频率
- 保底回退确保升级与网络异常下可用性

### D7: DataTable 大数据场景走轻量路径

**选择**：
- 将列宽测量节流并限定触发条件
- 超阈值（如 >200 行）默认服务端排序

**理由（最优性）**：
- 避免持续 DOM 测量和全量排序
- 保留小表场景的交互体验

### D8: 模板变异排序改不可变计算

**选择**：模板内 `selectedErrorCodes.sort(...)` 改为 `computed(() => [...selectedErrorCodes].sort(...))`。

**理由（最优性）**：
- 避免副作用与潜在渲染抖动
- 改动极小，收益稳定

### D9: 发布策略采用“开关 + 指标门禁 + 分阶段收敛”

**选择**：所有高影响优化通过开关灰度，达门禁后再全量。

**门禁建议**：
- `/admin/accounts` 首次加载 JS 传输量下降 >= 30%
- 首页关键链路 JS 体积不回升
- 前端 JS 错误率相对基线上升 < 0.05%
- 性能灰度期间无 P1 功能回归

**回滚策略**：
- 开关级回滚（分钟级）优先于代码回滚
- 任一门禁不达标立即回退对应开关

### D10: 灰度开关采用“运行时配置优先，编译时默认兜底”

**选择**：
- 生产环境灰度与回滚使用 `public_settings.perf_flags`（运行时）
- `VITE_*` 只作为开发和构建默认值兜底

**理由（最优性）**：
- 运行时开关可在不重新构建前端的前提下灰度/回滚
- 与当前项目 `window.__APP_CONFIG__` 注入机制兼容
- 旧前端可忽略未知配置字段，具备天然前向兼容

## Compatibility Design

为保证向前兼容与平滑升级，新增以下机制：

1. 默认兼容：新能力默认关闭（沿用旧行为）
2. 双路径并存：旧逻辑与新逻辑可共存一段观察窗口
3. 失败回退：远程模型配置失败自动回退本地快照
4. 逐步收敛：`legacy -> adaptive -> off` 或反向可切换
5. 混部兼容：滚动发布期间“旧前端 + 新配置 / 新前端 + 旧配置”均可工作

## Risks / Trade-offs

- 路由预取降载可能让“次跳转瞬时速度”略降
  - 通过自适应策略与灰度阈值平衡
- 过度拆包会增加请求数
  - 控制 chunk 数量，避免碎片化
- 远程模型配置引入可用性依赖
  - 本地快照兜底 + 缓存 TTL

## Migration Plan

1. Phase 0: 基线采集与埋点（不改行为）
2. Phase 1: 分包/异步加载/模板副作用修复
3. Phase 2: 运行时策略优化（预取/表格/重复调用）
4. Phase 3: 运行时灰度开关接入（`public_settings.perf_flags`）与混部验证
5. Phase 4: 灰度门禁、全量、观察与收敛

## Open Questions

- 无。当前方案已收敛，按上述迁移步骤执行。
